{% extends 'base.html' %}
{% load static i18n %}
{% load crispy_forms_tags thumbnail humanize %}

{% block title %}{% endblock %}

{% block head %}
{% endblock %}

{% block content %}

<!-- /.container -->
<div class="content-wrapper">
    <div class="row flex-grow mb-4">
        <div class="col-lg-3 grid-margin stretch-card">
            <!-- <h5>{% trans '欢迎回来，'%}{{request.user.username}}</h5> -->
            <input type="text"  id="searchDashboard" class="form-control" placeholder="{% trans '在此输入股票名称或代码'%}" aria-label="search" aria-describedby="search">
                
        </div>
    </div>
    <!-- <span>{% trans '您还未创建证券账户信息，请单击' %}<a href="{% url 'user:create_account' %}"><i class="fa fa-piggy-bank"></i>{% trans '此处' %}</a>{% trans '创建' %}</span> -->

    {% if dashboard %}
    {% ifequal dashboard.total_accounts 0 %}
    <div class="row">
        <span>{% trans '您还未创建证券账户信息，请单击' %}<a href="{% url 'user:create_account' %}"><i class="fa fa-piggy-bank"></i>{% trans '此处' %}</a>{% trans '创建' %}</span>
    </div>
    {% else %}
    <div class="row">
        <div class="col-lg-8 grid-margin stretch-card">
            <div class="row w-100 flex-grow">
                <div class="col-md-6 stretch-card">
                    <div class="card shadow">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between flex-wrap">
                                <p class="card-title"><i class="fa fa-coins"></i> {% trans '本周收益' %}</p>
                                <p class="font-weight-medium">
                                    <span class="text-danger" id="prfProfitRatio"></span>
                                </p>
                            </div>
                            <div class="d-flex align-items-center flex-wrapper mb-3">
                                <h5 class="font-weight-normal mb-0 mb-md-1 mb-lg-0 mr-3" id="prfAvgProfit"></h5>
                                <p class="text-muted mb-0">{% trans '平均收益' %}</p>
                            </div>
                            <canvas id="profitDevChartWeek" height="130"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 stretch-card">
                    <div class="card shadow">
                        <div class="card-body">
                            <div class="d-flex align-items-center
                                justify-content-between flex-wrap">
                                <p class="card-title"><i class="fa fa-arrow-alt-circle-left"></i>{% trans '本周交易成功率' %}</p>
                                <p class="text-danger font-weight-medium" id="invRelAttemptRatio"></p>
                            </div>
                            <div class="d-flex align-items-center flex-wrap
                                mb-3">
                                <h5 class="font-weight-normal mb-0 mb-md-1
                                    mb-lg-0 mr-3" id="invAvgAttempt"></h5>
                                <p class="text-muted mb-0">{% trans '平均成功次数' %}</p>
                            </div>
                            <canvas id="tradeSuccessRatio" height="130"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 grid-margin stretch-card">
                    <div class="card shadow mt-4 mb-4">
                        <div class="card-body">
                            <p class="card-title"><i class="fa fa-chart-line" ></i> {% trans '我的持仓' %}</p>
                            <div class="text-muted"> {% trans '今日收益（元）' %}</div>
                            <span class="text-danger">+485.5</span>
                            <div class="d-flex align-items-center justify-content-between flex-wrap mt-2">
                                <div class="text-muted"> 
                                    <div>{% trans '总市值' %}</div>
                                    <div>{{ dashboard.capital }}</div>
                                </div>
                                <div class="text-muted"> 
                                    <div>{% trans '总盈亏' %}</div>
                                    <div>{{ dashboard.profit_loss }}</div>
                                </div>
                                <div class="text-muted"> 
                                    <div>{% trans '持仓股票数' %}</div>
                                    <div>{{ dashboard.total_shares }}</div>
                                </div>
                                <div class="text-muted"> 
                                    <div>{% trans '管理账户数' %}</div>
                                    <div>{{ dashboard.total_accounts }}</div>
                                </div>

                            </div>
                            {% if dashboard %}
                            {% for p in dashboard.positions %}
                            <div class="card shadow mb-2 mt-2">
                                <div class="card-body">
                                    <div class='row'>
                                        <div class="col-lg-10">
                                            <h6 class="card-title"><a href="#" class="text-muted">{{ p.stock_name }}({% trans '账户:' %}{{ p.trade_account.account_name }})</h6>
                                            <h7 class="card-subtitle mb-2 text-muted"><a href="#"><a href="#" class="text-dark">{{ p.stock_code }}</a></h7>
                                        </div>
                                        
                                        <div class="col-lg-2">
                                            <div class="float-right">
                                            {% if p.profit < 0 %}
                                            <td><span class="badge badge-pill badge-success">{{ p.profit_ratio }}</span><span class="badge badge-pill badge-success">{{ p.profit }}</span></td>
                                            {% else %}
                                            <td><span class="badge badge-pill badge-danger">+{{ p.profit_ratio }}</span><span class="badge badge-pill badge-danger">+{{ p.profit }}</span></td>
                                            {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex align-items-center justify-content-between flex-wrap">
                                        <div class="text-muted"> 
                                            <div>{% trans '现价' %}</div>
                                            <div>{{ p.current_price }}</div>
                                        </div>
                                        <div class="text-muted"> 
                                            <div>{% trans '成本' %}</div>
                                            <div>{{ p.position_price }}</div>
                                        </div>
                                        <div class="text-muted">  <div>{% trans '持仓' %}{% trans '(目标仓位)' %}</div><div>{{ p.lots }}({{ p.target_position }})</div></div>
                                        <div class="text-muted">  <div>{% trans '市值' %}</div><div>{{ p.cash }}</div></div>

                                    </div>
                                    <hr>
                                    <div class="row col-lg-12 d-flex align-items-center justify-content-between">
                                        <div class="col-lg-3 d-flex align-items-center justify-content-between">
                                            <a class="btn btn-sm btn-outline-primary" href="{% url 'user:stock_trade' account=p.trade_account.id type='b' ts_code=p.stock_code %}">{% trans '买入+' %}</a>
                                            <a class="btn btn-sm btn-outline-primary" href="{% url 'user:stock_trade' account=p.trade_account.id type='s' ts_code=p.stock_code %}">{% trans '卖出-' %}</a>
                                        </div>
                                        <a class="btn btn-sm btn-outline-primary" href="{% url 'user:trade_log' symbol=p.stock_code %}">{% trans '查看详细交易' %}</a>
                                    
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% comment %} <div class="col-md-12 grid-margin stretch-card">
                    <div class="card shadow mb-4">
                        <div class="card-body">
                            <p class="card-title"><i class="fa fa-chart-line" ></i> {% trans '投资收益曲线' %}</p>
                            <p class="text-muted">25% more traffic than previous
                                week</p>
                            <canvas id="profitDevChart" height="150"></canvas>
                        </div>
                    </div>
                </div> {% endcomment %}
            </div>
            {% comment %}
            <div class="row w-100 flex-grow mt-4 mb-4 d-none">
                <div class="col-md-12 grid-margin stretch-card">
                    <div class="card shadow">
                        <div class="card-body pb-0">
                            <div class="d-flex justify-content-between flex-wrap">
                                <!-- <p class="text-muted">Last update: 2 Hours ago</p> -->
                                <p class="card-title">{% trans '最近交易' %}</p>
                                <div class="d-flex align-items-center flex-wrap mt-3 mb-3 mb-md-0">
                                    {% if dashboard %}
                                    {% for trade in dashboard.details %}
                                    <div class="card mb-4">
                                        <div class="card-body">
                                            <div class='row'>
                                                <div class="col-lg-10">
                                                    <h4 class="card-title"><a href="#"><i class="fa fa-chart-line"></i>{{ trade.stock_name }}</a></h4>
                                                    <h6 class="card-subtitle mb-2 text-muted"><a href="#"><a href="#">{{ trade.stock_code }}</a></h6>
                                                    <hr/>
                                                </div>
                                                
                                                <div class="col-lg-2">
                                                    <div class="float-right">
                                                    {% if trade.direction == 's' %}
                                                    <td><span class="badge badge-pill badge-success">{% trans '买出' %}</span></td>
                                                    {% else %}
                                                    <td><span class="badge badge-pill badge-danger">{% trans '买入' %}</span></td>
                                                    {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class='row'>
                                                <div class="col-lg-12">
                                                    <p class="card-text">{{ trade.trade_time }}  <a href="/user/{{trade.trader.id}}/profile">{{trade.trader.username}}</a> {% trans '以' %} {% trans '￥' %} {{ trade.price }} {% trans '交易' %} {{ trade.board_lots }}{% trans '股' %} {% trans '，本次交易投入' %}{% trans '￥' %} {{ trade.cash }}</p>
                                                    <p class="card-text">{% trans '该股的目标仓位为' %} {{ trade.target_position }} {% trans '股' %} </p>
                                                    <hr/>
                                                </div>
                                            </div>
                                            <div class='row'>
                                                <div class="col-lg-12">
                                                    <a href="#" class="card-link"><i class='fa fa-heart' aria-hidden="true"></i></a>
                                                    <a href="#" class="card-link"><i class='fa fa-share-alt' aria-hidden="true"></i></a>
                                                    <a href="#" class="card-link">{% trans '查看全部操作' %}</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endcomment %}
        </div>
        <div class="col-lg-4 grid-margin stretch-card">
            <div class="col-md-12 grid-margin stretch-card">
                <div class="col-md-12 grid-margin stretch-card">
                    <div class="card shadow mb-4">
                        <div class="card-body pb-0">
                            <div class="d-flex justify-content-between flex-wrap">
                                <div>
                                    <p class="card-title mr-1">
                                        <i class="fa fa-chart-bar" ></i> {% trans '我的仓位' %}
                                        <span class="badge badge-info badge-pill" id="pTotalShares">{{ dashboard.total_shares }}</span>

                                    </p>
                                </div>
                                <div>
                                    <span class="text-sm text-danger font-weight-medium" id="pTotalAvailPerTarget"></span>
                                </div>
                                
                            </div>
                            <div class="d-flex flex-wrap mb-2">
                                <div class="regional-chart-legend d-flex align-items-center flex-wrap mb-1" id="positionLegend"></div>
                                <canvas height="280" id="positionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 grid-margin stretch-card">
                    <div class="card shadow mb-4">
                        <div class="card-body pb-0">
                            <div class="d-flex align-items-center mb-4">
                                <p class="card-title mb-0 mr-1"><i class="fa fa-cog" ></i>  {% trans '交易策略' %}</p>
                                <span class="badge badge-info badge-pill" id="sTotalStrategies">{{ dashboard.total_strategies }}</span>
                            </div>
                            <div class="d-flex flex-wrap pt-2 small">
                                {% if dashboard %}
                                {% for s in dashboard.strategies %}
                                    <button type="button" class="btn btn-sm btn-light mb-2 ml-2"><i class="fa">{{ s.name }}</i></button>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <canvas height="150" id="activity-chart"></canvas>
                    </div>
                </div>
                <div class="col-md-12 grid-margin stretch-card">
                    <div class="card shadow mb-4">
                        <div class="card-body pb-0">
                            <div class="d-flex align-items-center mb-4">
                                <p class="card-title mb-0 mr-1">{% trans '我的自选股' %}</p>
                                <div class="badge badge-info badge-pill" id="fTotalFollowing">{{ dashboard.total_following }}</div>
                            </div>
                            <div class="d-flex flex-wrap pt-2 small">
                                {% if dashboard %}
                                {% for f in dashboard.followings %}
                                <button type="button" class="btn btn-sm btn-light mb-2 ml-2"><i class="fa fa-bar">{{f.stock_code.stock_name }}({{f.stock_code.stock_code }})</i></button>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <canvas height="150" id="activity-chart"></canvas>
                    </div>
                </div> 
            </div>
        </div>
    </div>
    {% endifequal %}
    {% endif %}
</div>
<!-- content-wrapper ends -->
{% endblock content %}

{% block javascript %}
{{ block.super }}
<script
    src="https://cdn.polyfill.io/v2/polyfill.js?features=default,String.prototype.repeat,Array.prototype.find,Array.prototype.findIndex,Math.trunc,Math.sign"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@1.19.3"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.0"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@0.2.0"></script>
<script src="{% static 'js/chartjs-chart-financial.v_0_1_1.js' %}"type="text/javascript"></script>
<!-- place project specific Javascript in this file -->
<!-- <script src="{% static 'js/charts-utils.js' %}" type="text/javascript"></script> -->
<script src="{% static 'js/dashboard.js' %}" type="text/javascript"></script>
{% endblock javascript %}